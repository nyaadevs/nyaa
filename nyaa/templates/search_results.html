{% from '_formhelpers.html' import render_category_select %}

{% macro render_column_header(header_class, header_style, center_text=False, sort_key=None, header_title=None) %}
{% set class_suffix = (search.sort == sort_key) and ("_" + search.order) or "" %}
{% set th_classes = filter_truthy([header_class, sort_key and "sorting" + class_suffix, center_text and "text-center"]) %}
<th {% if th_classes %} class="{{ ' '.join(th_classes) }}"{% endif %} {% if header_title %}title="{{ header_title }}"{% endif %} style="{{ header_style }}">
	{% if sort_key %}
	<a href="{% if class_suffix == '_desc' %}{{ modify_query(s=sort_key, o="asc") }}{% else %}{{ modify_query(s=sort_key, o="desc") }}{% endif %}"></a>
	{% endif %}
	{{ caller() }}
</th>
{% endmacro %}

{% if special_results is defined and not search.user %}
{% if special_results.first_word_user %}
<div class="alert alert-info">
	<a href="{{ url_for('view_user', user_name=special_results.first_word_user.username) }}{{ modify_query(q=special_results.query_sans_user)[1:] }}">Click here to see only results uploaded by {{ special_results.first_word_user.username }}</a>
</div>
{% endif %}
{% endif %}

{% macro render_torrent_card(torrent, is_current_user) %}
	{# This currently is not in use yet, but it's a card-like styling for torrents on mobile widths #}
    {% set cat_id = (torrent.main_category_id|string) + '_' + (torrent.sub_category_id|string) if use_elastic else (torrent.main_category.id|string) + '_' + (torrent.sub_category.id|string) %}
    {% set icon_dir = config.SITE_FLAVOR %}

    {% if use_elastic %}
        <section class="card-container">
            <header>
                <a href="/?c={{ cat_id }}" title="{{ torrent.main_category_id }} - {{ torrent.sub_category_id }}">
                    <img src="/static/img/icons/{{ icon_dir }}/{{ cat_id }}.png">
                </a>
                <input type="checkbox" class="checkbox" title="select">
            </header>
            <main>
                {{ torrent.display_name | escape }}
                {{ torrent.filesize | filesizeformat(True) }}
                {{ torrent.created_time | display_time }}
            </main>
            <aside>
                {% if config.ENABLE_SHOW_STATS %}
                    <i class="fa fa-arrow-up" aria-hidden="true"></i> {{ torrent.seed_count }}
                    <i class="fa fa-arrow-down" aria-hidden="true"></i> {{ torrent.leech_count }}
                    <i class="fa fa-check" aria-hidden="true"></i> {{ torrent.download_count }}
                {% endif %}
            </aside>
            <footer>
                {% if torrent.has_torrent %}<a href="{{ url_for('download_torrent', torrent_id=torrent.id) }}"><i class="fa fa-fw fa-download"></i></a>{% endif %}
                <a href="{{ create_magnet_from_info(torrent.display_name, torrent.info_hash) }}"><i class="fa fa-fw fa-magnet"></i></a>
            </footer>
        </section>
    {% else %}
        <section class="card-container">
            <header>
                <a href="/?c={{ cat_id }}" title="{{ torrent.main_category.name }} - {{ torrent.sub_category.name }}">
                    <img src="/static/img/icons/{{ icon_dir }}/{{ cat_id }}.png">
                </a>
                <strong>
                    <span data-timestamp="{{ torrent.created_utc_timestamp|int }}">{{ torrent.created_time.strftime('%Y-%m-%d %H:%M') }}</span>
                </strong>
                {% if is_current_user %}
                    <input type="checkbox" class="checkbox" name="selected_torrents" value="{{ torrent.id }}">
                {% endif %}
            </header>
            <main>
                <a class="title" href="{{ url_for('view_torrent', torrent_id=torrent.id) }}" title="{{ torrent.display_name | escape }}">
                    <span>{{ torrent.display_name | escape }}</span>
                </a>
            </main>
            <footer>
                <span>
                    <i class="fa fa-hdd-o" aria-hidden="true"></i> <span class="file-size">{{ torrent.filesize | filesizeformat(True) }}</span>
                    {% if torrent.has_torrent %}<a href="{{ url_for('download_torrent', torrent_id=torrent.id) }}"><i class="fa fa-fw fa-download"></i></a>{% endif %}
                    <a href="{{ torrent.magnet_uri }}"><i class="fa fa-fw fa-magnet"></i></a>
                </span>
                {% if config.ENABLE_SHOW_STATS %}
                <span class="stats">
                    <i class="fa fa-arrow-up" aria-hidden="true"></i> {{ torrent.stats.seed_count }}
                    <i class="fa fa-arrow-down" aria-hidden="true"></i> {{ torrent.stats.leech_count }}
                    <i class="fa fa-check" aria-hidden="true"></i> {{ torrent.stats.download_count }}
                </span>
                {% endif %}
            </footer>
        </section>
    {% endif %}
{% endmacro %}

{% macro user_form(user, is_available) %}
    {% if is_available %}
        <form class="form" id="torrent-mass-action-form" action="/user/{{ g.user.username }}/torrents" method="post">
            {{ mass_action_form.csrf_token }}
            <div class="form-group">
                <select name="action" id="action" class="form-control" title="action">
                    <option value="move_category">Move To Category</option>
                    <optgroup label="Hide / Unhide">
                        <option value="hide">Hide</option>
                        <option value="unhide">Unhide</option>
                    </optgroup>
                    <optgroup label="Remake">
                        <option value="remake">Remake</option>
                        <option value="unremake">Unremake</option>
                    </optgroup>
                    {% if user.is_admin  %}
                    <optgroup label="Admin">
                        <option value="delete">Delete</option>
                        <option value="anonymise">Make Anonymous</option>
                        <option value="unanonymise">Remove Anonymity</option>
                    </optgroup>
                    {% endif %}
                </select>
                <div class="category-select">
                    {{ render_category_select('category') }}
                </div>
                <div class="btn-container">
                    <button class="btn btn-success" id="select-all">Select Visible Items</button>
                    <button type="submit" class="btn btn-primary" id="apply-action">Apply</button>
                </div>
            </div>

            {{ caller() }}

        </form>
    {% else %}
        {{ caller() }}
    {% endif %}
{% endmacro %}

{% if (use_elastic and torrent_query.hits.total > 0) or (torrent_query.items) %}

{% call user_form(user, is_current_user) %}
    <div class="table-responsive">
        <table class="table table-bordered table-hover table-striped torrent-list">
            <thead>
            <tr>
                {% if is_current_user %}
                    <th></th>
                {% endif %}
				{% call render_column_header("hdr-category", "width:80px;", center_text=True) %}
					<div>Category</div>
				{% endcall %}
				{% call render_column_header("hdr-name", "width:auto;") %}
					<div>Name</div>
				{% endcall %}
				{% call render_column_header("hdr-comments", "width:50px;", center_text=True, sort_key="comments", header_title="Comments") %}
					<i class="fa fa-comments-o"></i>
				{% endcall %}
				{% call render_column_header("hdr-link", "width:70px;", center_text=True) %}
					<div>Link</div>
				{% endcall %}
				{% call render_column_header("hdr-size", "width:100px;", center_text=True, sort_key="size") %}
					<div>Size</div>
				{% endcall %}
				{% call render_column_header("hdr-date", "width:140px;", center_text=True, sort_key="id", header_title="In UTC") %}
					<div>Date</div>
				{% endcall %}

				{% if config.ENABLE_SHOW_STATS %}
				{% call render_column_header("hdr-seeders", "width:50px;", center_text=True, sort_key="seeders", header_title="Seeders") %}
					<i class="fa fa-arrow-up" aria-hidden="true"></i>
				{% endcall %}
				{% call render_column_header("hdr-leechers", "width:50px;", center_text=True, sort_key="leechers", header_title="Leechers") %}
					<i class="fa fa-arrow-down" aria-hidden="true"></i>
				{% endcall %}
				{% call render_column_header("hdr-downloads", "width:50px;", center_text=True, sort_key="downloads", header_title="Completed downloads") %}
					<i class="fa fa-check" aria-hidden="true"></i>
				{% endcall %}
				{% endif %}
			</tr>
		</thead>
		<tbody>
			{% set torrents = torrent_query if use_elastic else torrent_query.items %}
			{% for torrent in torrents %}
			<tr class="{% if torrent.deleted %}deleted{% elif torrent.hidden %}warning{% elif torrent.remake %}danger{% elif torrent.trusted %}success{% else %}default{% endif %}">
				{% set cat_id = use_elastic and ((torrent.main_category_id|string) + '_' + (torrent.sub_category_id|string)) or torrent.sub_category.id_as_string %}
				{% set icon_dir = config.SITE_FLAVOR %}
                    {% if is_current_user %}
                        <td class="checkbox-column">
                            <input type="checkbox" class="checkbox" name="selected_torrents" value="{{ torrent.id }}">
                        </td>
                    {% endif %}
				<td style="padding:0 4px;">
				{% if use_elastic %}
				<a href="{{ url_for('home', c=cat_id) }}" title="{{ category_name(cat_id) }}">
				{% else %}
				<a href="{{ url_for('home', c=cat_id) }}" title="{{ torrent.main_category.name }} - {{ torrent.sub_category.name }}">
				{% endif %}
					<img src="{{ url_for('static', filename='img/icons/%s/%s.png'|format(icon_dir, cat_id)) }}" alt="{{ category_name(cat_id) }}">
				</a>
				</td>
				<td colspan="2">
					{% set torrent_id = torrent.meta.id if use_elastic else torrent.id %}
					{% set com_count = torrent.comment_count %}
					{% if com_count %}
					<a href="{{ url_for('view_torrent', torrent_id=torrent_id, _anchor='comments') }}" class="comments" title="{{ '{c} comment{s}'.format(c=com_count, s='s' if com_count > 1 else '') }}">
						<i class="fa fa-comments-o"></i>{{ com_count -}}
					</a>
					{% endif %}
					{% if use_elastic %}
					<a href="{{ url_for('view_torrent', torrent_id=torrent_id) }}" title="{{ torrent.display_name | escape }}">{%if "highlight" in torrent.meta %}{{ torrent.meta.highlight.display_name[0] | safe }}{% else %}{{torrent.display_name}}{%endif%}</a>
					{% else %}
					<a href="{{ url_for('view_torrent', torrent_id=torrent_id) }}" title="{{ torrent.display_name | escape }}">{{ torrent.display_name | escape }}</a>
					{% endif %}
				</td>
				<td class="text-center" style="white-space: nowrap;">
					{% if torrent.has_torrent %}<a href="{{ url_for('download_torrent', torrent_id=torrent_id) }}"><i class="fa fa-fw fa-download"></i></a>{% endif %}
					{% if use_elastic %}
					<a href="{{ create_magnet_from_es_info(torrent.display_name, torrent.info_hash) }}"><i class="fa fa-fw fa-magnet"></i></a>
					{% else %}
					<a href="{{ torrent.magnet_uri }}"><i class="fa fa-fw fa-magnet"></i></a>
					{% endif %}
				</td>
				<td class="text-center">{{ torrent.filesize | filesizeformat(True) }}</td>
				{% if use_elastic %}
				<td class="text-center" data-timestamp="{{ torrent.created_time | utc_time }}">{{ torrent.created_time | display_time }}</td>
				{% else %}
				<td class="text-center" data-timestamp="{{ torrent.created_utc_timestamp | int }}">{{ torrent.created_time.strftime('%Y-%m-%d %H:%M') }}</td>
				{% endif %}
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
{% endcall %}
{% else %}
<h3>No results found</h3>
{% endif %}

<div class="center">
	{% if use_elastic %}
	{{ pagination.info }}
	{{ pagination.links }}
	{% else %}
	{% from "bootstrap/pagination.html" import render_pagination %}
	{{ render_pagination(torrent_query) }}
	{% endif %}
</div>
